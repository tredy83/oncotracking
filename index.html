<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ONCOTRACKING</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100">

<div id="app">
    <div class="flex items-center justify-center h-screen">
        <div class="text-center">
            <div class="text-4xl mb-4">‚è≥</div>
            <p class="text-xl font-bold">Caricamento ONCOTRACKING...</p>
        </div>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<script>
const firebaseConfig = {
    apiKey: "AIzaSyAeuckvJxS9HHsEBO0GTumUj0P_0Agc6E0",
    authDomain: "oncotracking.firebaseapp.com",
    projectId: "oncotracking",
    storageBucket: "oncotracking.firebasestorage.app",
    messagingSenderId: "481368228030",
    appId: "1:481368228030:web:b3306b3fc19a8d68c61eef"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

const APP = {
    view: 'home',
    personnel: [],
    activities: [],
    timeLogs: [],
    selectedPerson: null,
    activeTab: 'IN_ORARIO',
    search: '',
    menuOpen: false,
    loading: true
};

function initFirebase() {
    db.collection('personnel').where('attivo', '==', true).onSnapshot(function(snapshot) {
        APP.personnel = [];
        snapshot.forEach(function(doc) {
            APP.personnel.push({ id: doc.id, ...doc.data() });
        });
        APP.loading = false;
        render();
    });

    db.collection('activities').where('attiva', '==', true).onSnapshot(function(snapshot) {
        APP.activities = [];
        snapshot.forEach(function(doc) {
            APP.activities.push({ id: doc.id, ...doc.data() });
        });
        render();
    });

    db.collection('timeLogs').orderBy('startTime', 'desc').limit(100).onSnapshot(function(snapshot) {
        APP.timeLogs = [];
        snapshot.forEach(function(doc) {
            const data = doc.data();
            APP.timeLogs.push({
                id: doc.id,
                personnelId: data.personnelId,
                activityId: data.activityId,
                categoria: data.categoria,
                startTime: data.startTime.toDate().toISOString(),
                endTime: data.endTime ? data.endTime.toDate().toISOString() : null,
                durationMinutes: data.durationMinutes,
                note: data.note || '',
                source: data.source
            });
        });
        render();
    });
}

async function seedInitialData() {
    const personnelSnapshot = await db.collection('personnel').get();
    if (personnelSnapshot.empty) {
        const batch = db.batch();
        const personnel = [
            {nome: 'Anna', cognome: 'M.'}, {nome: 'Elena', cognome: 'M.'}, {nome: 'Alessio', cognome: 'S.'},
            {nome: 'Federica', cognome: 'L.'}, {nome: 'Benedetta', cognome: 'U.'}, {nome: 'Ilaria', cognome: 'C.'},
            {nome: 'Andrea', cognome: 'S.'}, {nome: 'Andrea', cognome: 'M.'}, {nome: 'Monia', cognome: 'S.'},
            {nome: 'Martina', cognome: 'M.'}, {nome: 'Massimo', cognome: 'G.'}, {nome: 'Giuseppe', cognome: 'B.'},
            {nome: 'Laura', cognome: 'M.'}, {nome: 'Alessandra', cognome: 'S.'}
        ];
        personnel.forEach(function(p) {
            const ref = db.collection('personnel').doc();
            batch.set(ref, { nome: p.nome, cognome: p.cognome, attivo: true });
        });
        await batch.commit();
    } else {
        // Controllo duplicati - rimuove persone duplicate mantenendo solo la prima
        const seenNames = {};
        const duplicates = [];
        
        personnelSnapshot.forEach(function(doc) {
            const data = doc.data();
            const key = data.nome + '|' + data.cognome;
            
            if (seenNames[key]) {
                duplicates.push(doc.id);
            } else {
                seenNames[key] = doc.id;
            }
        });
        
        // Elimina duplicati se presenti
        if (duplicates.length > 0) {
            const batch = db.batch();
            duplicates.forEach(function(id) {
                batch.delete(db.collection('personnel').doc(id));
            });
            await batch.commit();
            console.log('Rimossi ' + duplicates.length + ' duplicati');
        }
    }

    const activitiesSnapshot = await db.collection('activities').get();
    if (activitiesSnapshot.empty) {
        const batch = db.batch();
        const activities = [
            'Consulenze', 'Prime Visite', 'Estrazione Cartelle Cliniche', 'Preparazione Ambulatori',
            'Preparazione Prime Visite', 'Discussione Casi PDTA', 'Chiusura PAC', 'Chiusura SDO',
            'Partecipazione PDTA', 'Attivit√† Referenza PDTA', 'Attivit√† Studio/Aggiornamento'
        ];
        activities.forEach(function(name) {
            const ref = db.collection('activities').doc();
            batch.set(ref, { nome: name, attiva: true });
        });
        await batch.commit();
    }
}

function render() {
    if (APP.loading) return;
    const app = document.getElementById('app');
    if (APP.view === 'home') app.innerHTML = renderHome();
    else if (APP.view === 'person') app.innerHTML = renderPerson();
    else if (APP.view === 'manual') app.innerHTML = renderManual();
    else if (APP.view === 'history') app.innerHTML = renderHistory();
    else if (APP.view === 'reports') app.innerHTML = renderReports();
    else if (APP.view === 'admin-personnel') app.innerHTML = renderAdminPersonnel();
    else if (APP.view === 'admin-activities') app.innerHTML = renderAdminActivities();
    startTimers();
}

function renderHeader(title, showBack) {
    let h = '<div style="background:linear-gradient(135deg,#667eea 0%,#764ba2 100%)" class="text-white p-4 sticky top-0 z-50 shadow-lg"><div class="flex items-center justify-between"><div class="flex items-center gap-3">';
    if (showBack) h += '<button onclick="goHome()" class="text-2xl font-bold">‚Üê</button>';
    h += '<h1 class="text-xl font-bold">' + title + '</h1></div><button onclick="toggleMenu()" class="text-2xl">‚ò∞</button></div>';
    if (APP.menuOpen) {
        h += '<div class="mt-4 bg-white text-gray-800 rounded-lg p-2">';
        h += '<button onclick="setView(\'home\')" class="block w-full text-left p-3 hover:bg-gray-100 rounded">üè† Home</button>';
        h += '<button onclick="setView(\'reports\')" class="block w-full text-left p-3 hover:bg-gray-100 rounded">üìä Report</button>';
        h += '<button onclick="setView(\'admin-personnel\')" class="block w-full text-left p-3 hover:bg-gray-100 rounded">üë• Gestione Personale</button>';
        h += '<button onclick="setView(\'admin-activities\')" class="block w-full text-left p-3 hover:bg-gray-100 rounded">üìã Gestione Attivit√†</button></div>';
    }
    h += '</div>';
    return h;
}

function renderHome() {
    const filtered = APP.personnel.filter(function(p) {
        return p.attivo && (APP.search === '' || (p.nome + ' ' + p.cognome).toLowerCase().indexOf(APP.search.toLowerCase()) >= 0);
    });
    let h = renderHeader('ONCOTRACKING', false);
    h += '<div class="p-4 pb-20"><input type="text" id="search-input" placeholder="Cerca..." value="' + APP.search + '" oninput="updateSearch(this.value)" class="w-full p-3 mb-4 border-2 rounded-lg text-lg">';
    for (let i = 0; i < filtered.length; i++) {
        const p = filtered[i];
        const log = APP.timeLogs.find(function(l) { return l.personnelId === p.id && !l.endTime; });
        const act = log ? APP.activities.find(function(a) { return a.id === log.activityId; }) : null;
        h += '<div onclick="selectPerson(\'' + p.id + '\')" class="bg-white p-4 rounded-lg shadow mb-3 cursor-pointer ' + (log ? 'border-2 border-green-500' : '') + '"><div class="flex justify-between items-center"><div><h3 class="text-xl font-bold">' + p.nome + ' ' + p.cognome + '</h3>';
        if (log && act) h += '<p class="text-green-600 font-bold mt-2">‚è± ' + act.nome + '</p>';
        h += '</div>';
        if (log) h += '<span class="bg-green-500 text-white px-3 py-1 rounded-full text-sm">ATTIVO</span>';
        h += '</div></div>';
    }
    if (filtered.length === 0) h += '<p class="text-center text-gray-500 mt-8">Nessun risultato</p>';
    h += '</div>';
    return h;
}

function renderPerson() {
    const p = APP.personnel.find(function(x) { return x.id === APP.selectedPerson; });
    if (!p) return renderHome();
    const log = APP.timeLogs.find(function(l) { return l.personnelId === p.id && !l.endTime; });
    let h = renderHeader(p.nome + ' ' + p.cognome, true);
    h += '<div class="p-4 pb-20">';
    if (log) {
        h += '<div class="bg-green-500 text-white p-4 rounded-lg mb-4"><p class="text-sm">Timer in corso</p><p class="text-2xl font-bold" id="timer-' + log.id + '">00:00:00</p><button onclick="stopTimer(\'' + log.id + '\')" class="mt-2 bg-white text-green-600 px-6 py-2 rounded-lg font-bold">STOP</button></div>';
    }
    h += '<div class="flex gap-2 mb-4"><button onclick="setTab(\'IN_ORARIO\')" class="flex-1 py-3 rounded-lg font-bold ' + (APP.activeTab === 'IN_ORARIO' ? 'bg-blue-600 text-white' : 'bg-gray-200') + '">In Orario</button><button onclick="setTab(\'FUORI_ORARIO\')" class="flex-1 py-3 rounded-lg font-bold ' + (APP.activeTab === 'FUORI_ORARIO' ? 'bg-purple-600 text-white' : 'bg-gray-200') + '">Fuori Orario</button></div>';
    for (let i = 0; i < APP.activities.length; i++) {
        const a = APP.activities[i];
        if (!a.attiva) continue;
        const isActive = log && log.activityId === a.id;
        h += '<button onclick="' + (!isActive ? 'startTimer(\'' + p.id + '\',\'' + a.id + '\',\'' + APP.activeTab + '\')' : '') + '" class="w-full p-4 mb-3 rounded-lg text-left font-bold text-lg ' + (isActive ? 'bg-green-500 text-white' : 'bg-white border-2') + '">' + a.nome + '</button>';
    }
    h += '<button onclick="setView(\'manual\')" class="w-full bg-orange-500 text-white py-4 rounded-lg font-bold mt-4">‚ûï Inserimento Manuale</button>';
    h += '<button onclick="setView(\'history\')" class="w-full bg-gray-700 text-white py-4 rounded-lg font-bold mt-2">üìã Storico</button></div>';
    return h;
}

function renderManual() {
    let h = renderHeader('Inserimento Manuale', true);
    h += '<div class="p-4"><form onsubmit="submitManual(event); return false;" class="bg-white p-4 rounded-lg space-y-4">';
    h += '<select name="personnelId" required class="w-full p-3 border-2 rounded-lg"><option value="">Seleziona persona...</option>';
    for (let i = 0; i < APP.personnel.length; i++) {
        const p = APP.personnel[i];
        if (p.attivo) h += '<option value="' + p.id + '" ' + (p.id === APP.selectedPerson ? 'selected' : '') + '>' + p.nome + ' ' + p.cognome + '</option>';
    }
    h += '</select><select name="activityId" required class="w-full p-3 border-2 rounded-lg"><option value="">Seleziona attivit√†...</option>';
    for (let i = 0; i < APP.activities.length; i++) {
        const a = APP.activities[i];
        if (a.attiva) h += '<option value="' + a.id + '">' + a.nome + '</option>';
    }
    h += '</select><select name="categoria" required class="w-full p-3 border-2 rounded-lg"><option value="IN_ORARIO">In Orario</option><option value="FUORI_ORARIO">Fuori Orario</option></select>';
    
    const today = new Date().toISOString().split('T')[0];
    h += '<div><label class="block font-bold mb-2 text-gray-700">üìÖ Selezionare Data</label>';
    h += '<input type="date" name="date" required value="' + today + '" max="' + today + '" class="w-full p-3 border-2 border-blue-400 rounded-lg bg-blue-50 text-lg font-semibold"></div>';
    
    h += '<div class="grid grid-cols-2 gap-4">';
    h += '<div><label class="block font-bold mb-2 text-gray-700">‚è∞ Ora Inizio</label>';
    h += '<input type="time" name="startTime" required class="w-full p-3 border-2 border-green-400 rounded-lg bg-green-50 text-lg font-semibold"></div>';
    h += '<div><label class="block font-bold mb-2 text-gray-700">‚è±Ô∏è Ora Fine</label>';
    h += '<input type="time" name="endTime" required class="w-full p-3 border-2 border-red-400 rounded-lg bg-red-50 text-lg font-semibold"></div>';
    h += '</div>';
    
    h += '<textarea name="note" placeholder="Note (opzionale)" class="w-full p-3 border-2 rounded-lg" rows="3"></textarea><button type="submit" class="w-full bg-green-600 text-white py-3 rounded-lg font-bold">Salva</button></form></div>';
    return h;
}

function renderHistory() {
    const p = APP.personnel.find(function(x) { return x.id === APP.selectedPerson; });
    const logs = APP.timeLogs.filter(function(l) { return l.personnelId === APP.selectedPerson && l.endTime; }).reverse();
    let h = renderHeader('Storico: ' + p.nome + ' ' + p.cognome, true);
    h += '<div class="p-4">';
    if (logs.length === 0) h += '<p class="text-center text-gray-500 mt-8">Nessuna attivit√† completata</p>';
    else {
        for (let i = 0; i < logs.length; i++) {
            const log = logs[i];
            const act = APP.activities.find(function(a) { return a.id === log.activityId; });
            const hh = Math.floor(log.durationMinutes / 60);
            const m = log.durationMinutes % 60;
            const date = new Date(log.startTime);
            h += '<div class="bg-white p-4 rounded-lg shadow mb-3"><div class="flex justify-between items-start">';
            h += '<div class="flex-1"><h3 class="font-bold">' + (act ? act.nome : 'Attivit√† eliminata') + '</h3><p class="text-sm text-gray-600">' + date.toLocaleDateString('it-IT') + ' ‚Ä¢ ' + log.categoria.replace('_', ' ') + '</p><p class="text-green-600 font-bold mt-2">' + hh + 'h ' + m + 'm</p>';
            if (log.note) h += '<p class="text-sm mt-2">' + log.note + '</p>';
            h += '</div>';
            h += '<button onclick="deleteLog(\'' + log.id + '\')" class="ml-3 bg-red-500 hover:bg-red-600 text-white px-3 py-2 rounded-lg font-bold flex items-center gap-1"><span>üóëÔ∏è</span><span>Elimina</span></button>';
            h += '</div></div>';
        }
    }
    h += '</div>';
    return h;
}

function renderReports() {
    const stats = {};
    const inOrarioStats = {};
    const fuoriOrarioStats = {};
    const activeLogs = [];
    
    for (let i = 0; i < APP.timeLogs.length; i++) {
        const log = APP.timeLogs[i];
        
        if (!log.endTime) {
            activeLogs.push(log);
            continue;
        }
        
        const p = APP.personnel.find(function(x) { return x.id === log.personnelId; });
        if (!p) continue;
        const key = p.nome + ' ' + p.cognome;
        
        if (!stats[key]) stats[key] = { minutes: 0, count: 0 };
        stats[key].minutes += log.durationMinutes;
        stats[key].count++;
        
        if (log.categoria === 'IN_ORARIO') {
            if (!inOrarioStats[key]) inOrarioStats[key] = { minutes: 0, count: 0 };
            inOrarioStats[key].minutes += log.durationMinutes;
            inOrarioStats[key].count++;
        } else {
            if (!fuoriOrarioStats[key]) fuoriOrarioStats[key] = { minutes: 0, count: 0 };
            fuoriOrarioStats[key].minutes += log.durationMinutes;
            fuoriOrarioStats[key].count++;
        }
    }
    
    let h = renderHeader('Report', true);
    h += '<div class="p-4">';
    
    if (activeLogs.length > 0) {
        h += '<div class="bg-yellow-50 border-2 border-yellow-500 p-4 rounded-lg mb-4">';
        h += '<h3 class="font-bold text-yellow-800 mb-3 flex items-center gap-2"><span class="text-2xl">‚è±Ô∏è</span> Timer Attivi</h3>';
        
        for (let i = 0; i < activeLogs.length; i++) {
            const log = activeLogs[i];
            const person = APP.personnel.find(function(p) { return p.id === log.personnelId; });
            const activity = APP.activities.find(function(a) { return a.id === log.activityId; });
            
            if (!person || !activity) continue;
            
            const startTime = new Date(log.startTime);
            const now = new Date();
            const elapsedMinutes = Math.floor((now - startTime) / 60000);
            const eh = Math.floor(elapsedMinutes / 60);
            const em = elapsedMinutes % 60;
            
            const catColor = log.categoria === 'IN_ORARIO' ? 'text-green-700' : 'text-purple-700';
            const catBg = log.categoria === 'IN_ORARIO' ? 'bg-green-100' : 'bg-purple-100';
            
            h += '<div class="bg-white p-3 rounded-lg mb-2 border-l-4 ' + (log.categoria === 'IN_ORARIO' ? 'border-green-500' : 'border-purple-500') + '">';
            h += '<div class="flex justify-between items-center">';
            h += '<div>';
            h += '<p class="font-bold text-lg">' + person.nome + ' ' + person.cognome + '</p>';
            h += '<p class="text-sm text-gray-600">' + activity.nome + '</p>';
            h += '<p class="text-xs ' + catColor + ' font-semibold mt-1 inline-block px-2 py-1 rounded ' + catBg + '">' + log.categoria.replace('_', ' ') + '</p>';
            h += '</div>';
            h += '<div class="text-right">';
            h += '<p class="text-2xl font-bold text-yellow-700" id="active-timer-' + log.id + '">' + eh + 'h ' + em + 'm</p>';
            h += '<p class="text-xs text-gray-500">in corso...</p>';
            h += '</div></div></div>';
        }
        
        h += '</div>';
    }
    
    h += '<div class="bg-blue-50 border-2 border-blue-500 p-4 rounded-lg mb-4">';
    h += '<h3 class="font-bold text-blue-800 mb-2">üìä Totali Complessivi</h3>';
    const keys = Object.keys(stats);
    if (keys.length > 0) {
        let totalMinutes = 0;
        let totalCount = 0;
        for (let i = 0; i < keys.length; i++) {
            totalMinutes += stats[keys[i]].minutes;
            totalCount += stats[keys[i]].count;
        }
        const th = Math.floor(totalMinutes / 60);
        const tm = totalMinutes % 60;
        h += '<p class="text-2xl font-bold text-blue-600">' + th + 'h ' + tm + 'm</p>';
        h += '<p class="text-sm text-gray-600">' + totalCount + ' attivit√† completate</p>';
    } else {
        h += '<p class="text-gray-500">Nessuna attivit√† completata</p>';
    }
    h += '</div>';
    
    h += '<div class="grid grid-cols-2 gap-4 mb-4">';
    h += '<div class="bg-green-50 border-2 border-green-500 p-3 rounded-lg">';
    h += '<h4 class="font-bold text-green-800 text-sm mb-2">Extra IN Orario</h4>';
    const inKeys = Object.keys(inOrarioStats);
    if (inKeys.length > 0) {
        let inTotal = 0;
        for (let i = 0; i < inKeys.length; i++) inTotal += inOrarioStats[inKeys[i]].minutes;
        const ih = Math.floor(inTotal / 60);
        const im = inTotal % 60;
        h += '<p class="text-xl font-bold text-green-600">' + ih + 'h ' + im + 'm</p>';
    } else {
        h += '<p class="text-gray-500">Nessun dato</p>';
    }
    h += '</div>';
    
    h += '<div class="bg-purple-50 border-2 border-purple-500 p-3 rounded-lg">';
    h += '<h4 class="font-bold text-purple-800 text-sm mb-2">Extra FUORI Orario</h4>';
    const outKeys = Object.keys(fuoriOrarioStats);
    if (outKeys.length > 0) {
        let outTotal = 0;
        for (let i = 0; i < outKeys.length; i++) outTotal += fuoriOrarioStats[outKeys[i]].minutes;
        const oh = Math.floor(outTotal / 60);
        const om = outTotal % 60;
        h += '<p class="text-xl font-bold text-purple-600">' + oh + 'h ' + om + 'm</p>';
    } else {
        h += '<p class="text-gray-500">Nessun dato</p>';
    }
    h += '</div></div>';
    
    h += '<div class="bg-white p-4 rounded-lg shadow mb-4"><h3 class="font-bold mb-4">Dettaglio per Persona</h3>';
    if (keys.length === 0) {
        h += '<p class="text-gray-500">Nessun dato disponibile</p>';
    } else {
        for (let i = 0; i < keys.length; i++) {
            const name = keys[i];
            const data = stats[name];
            const hh = Math.floor(data.minutes / 60);
            const m = data.minutes % 60;
            
            const inData = inOrarioStats[name] || { minutes: 0, count: 0 };
            const outData = fuoriOrarioStats[name] || { minutes: 0, count: 0 };
            
            h += '<div class="py-3 border-b"><div class="flex justify-between mb-2"><span class="font-semibold">' + name + '</span><div class="text-right"><p class="font-bold">' + hh + 'h ' + m + 'm</p><p class="text-xs text-gray-600">' + data.count + ' attivit√†</p></div></div>';
            h += '<div class="flex gap-4 text-sm"><span class="text-green-600">In orario: ' + Math.floor(inData.minutes/60) + 'h ' + (inData.minutes%60) + 'm (' + inData.count + ')</span>';
            h += '<span class="text-purple-600">Fuori orario: ' + Math.floor(outData.minutes/60) + 'h ' + (outData.minutes%60) + 'm (' + outData.count + ')</span></div></div>';
        }
    }
    h += '</div>';
    
    h += '<button onclick="exportExcel()" class="w-full bg-blue-600 text-white py-4 rounded-lg font-bold mb-2">üì• Esporta Report Excel Completo</button>';
    h += '<p class="text-xs text-center text-gray-500">Include: Log dettagliato, Riepilogo per persona, Riepilogo per attivit√†</p>';
    h += '</div>';
    
    startActiveTimers();
    
    return h;
}

function startActiveTimers() {
    const activeLogs = APP.timeLogs.filter(function(l) { return !l.endTime; });
    
    for (let i = 0; i < activeLogs.length; i++) {
        const log = activeLogs[i];
        const el = document.getElementById('active-timer-' + log.id);
        if (el) {
            // Aggiorna immediatamente
            updateTimerDisplay(el, log);
            
            // Poi aggiorna ogni 5 secondi
            setInterval(function() {
                updateTimerDisplay(el, log);
            }, 5000);
        }
    }
}

function updateTimerDisplay(element, log) {
    const start = new Date(log.startTime);
    const now = new Date();
    const elapsedMinutes = Math.floor((now - start) / 60000);
    const h = Math.floor(elapsedMinutes / 60);
    const m = elapsedMinutes % 60;
    element.textContent = h + 'h ' + m + 'm';
}

function renderAdminPersonnel() {
    let h = renderHeader('Gestione Personale', true);
    h += '<div class="p-4"><form onsubmit="addPerson(event); return false;" class="bg-white p-4 rounded-lg shadow mb-4 space-y-3"><h3 class="font-bold">Aggiungi Persona</h3><input type="text" name="nome" placeholder="Nome" required class="w-full p-3 border-2 rounded-lg"><input type="text" name="cognome" placeholder="Cognome" required class="w-full p-3 border-2 rounded-lg"><button type="submit" class="w-full bg-green-600 text-white py-3 rounded-lg font-bold">Aggiungi</button></form>';
    h += '<div id="all-personnel"></div></div>';
    loadAllPersonnel();
    return h;
}

function renderAdminActivities() {
    let h = renderHeader('Gestione Attivit√†', true);
    h += '<div class="p-4"><form onsubmit="addActivity(event); return false;" class="bg-white p-4 rounded-lg shadow mb-4 space-y-3"><h3 class="font-bold">Aggiungi Attivit√†</h3><input type="text" name="nome" placeholder="Nome attivit√†" required class="w-full p-3 border-2 rounded-lg"><p class="text-sm text-gray-600">Disponibile in entrambe le categorie</p><button type="submit" class="w-full bg-green-600 text-white py-3 rounded-lg font-bold">Aggiungi</button></form>';
    h += '<div id="all-activities"></div></div>';
    loadAllActivities();
    return h;
}

function loadAllPersonnel() {
    db.collection('personnel').get().then(function(snapshot) {
        let h = '';
        const allPersonnel = [];
        snapshot.forEach(function(doc) {
            allPersonnel.push({ id: doc.id, ...doc.data() });
        });
        
        allPersonnel.sort(function(a, b) {
            const nameA = a.nome + ' ' + a.cognome;
            const nameB = b.nome + ' ' + b.cognome;
            return nameA.localeCompare(nameB);
        });
        
        db.collection('timeLogs').get().then(function(logsSnapshot) {
            const personnelWithLogs = {};
            logsSnapshot.forEach(function(doc) {
                const log = doc.data();
                personnelWithLogs[log.personnelId] = true;
            });
            
            for (let i = 0; i < allPersonnel.length; i++) {
                const p = allPersonnel[i];
                const hasLogs = personnelWithLogs[p.id];
                
                h += '<div class="bg-white p-4 rounded-lg shadow mb-3 ' + (!p.attivo ? 'opacity-50' : '') + '">';
                h += '<div class="flex justify-between items-center">';
                h += '<div><h3 class="font-bold">' + p.nome + ' ' + p.cognome + '</h3>';
                if (hasLogs) h += '<p class="text-xs text-gray-500">Ha attivit√† registrate</p>';
                h += '</div>';
                h += '<div class="flex gap-2">';
                
                h += '<button onclick="editPerson(\'' + p.id + '\',\'' + p.nome + '\',\'' + p.cognome + '\')" class="px-4 py-2 rounded-lg font-bold bg-blue-500 text-white">‚úèÔ∏è Modifica</button>';
                
                if (hasLogs) {
                    h += '<button onclick="togglePersonActive(\'' + p.id + '\',' + p.attivo + ')" class="px-4 py-2 rounded-lg font-bold ' + (p.attivo ? 'bg-orange-500' : 'bg-green-500') + ' text-white">';
                    h += p.attivo ? 'Disattiva' : 'Riattiva';
                    h += '</button>';
                } else {
                    h += '<button onclick="deletePerson(\'' + p.id + '\')" class="px-4 py-2 rounded-lg font-bold bg-red-600 text-white">Elimina</button>';
                }
                
                h += '</div></div></div>';
            }
            document.getElementById('all-personnel').innerHTML = h;
        });
    });
}

function loadAllActivities() {
    db.collection('activities').get().then(function(snapshot) {
        let h = '';
        snapshot.forEach(function(doc) {
            const a = { id: doc.id, ...doc.data() };
            h += '<div class="bg-white p-4 rounded-lg shadow mb-3 ' + (!a.attiva ? 'opacity-50' : '') + '"><div class="flex justify-between items-center"><h3 class="font-bold">' + a.nome + '</h3><button onclick="toggleActivityActive(\'' + a.id + '\',' + a.attiva + ')" class="px-4 py-2 rounded-lg font-bold ' + (a.attiva ? 'bg-red-500' : 'bg-green-500') + ' text-white">' + (a.attiva ? 'Disattiva' : 'Riattiva') + '</button></div></div>';
        });
        document.getElementById('all-activities').innerHTML = h;
    });
}

function startTimers() {
    const logs = APP.timeLogs.filter(function(l) { return !l.endTime; });
    for (let i = 0; i < logs.length; i++) {
        const log = logs[i];
        const el = document.getElementById('timer-' + log.id);
        if (el) {
            setInterval(function() {
                const start = new Date(log.startTime);
                const diff = Math.floor((new Date() - start) / 1000);
                const h = Math.floor(diff / 3600);
                const m = Math.floor((diff % 3600) / 60);
                const s = diff % 60;
                el.textContent = String(h).padStart(2,'0') + ':' + String(m).padStart(2,'0') + ':' + String(s).padStart(2,'0');
            }, 1000);
        }
    }
}

window.setView = function(view) { APP.view = view; APP.menuOpen = false; render(); };
window.goHome = function() { APP.view = 'home'; APP.selectedPerson = null; render(); };
window.toggleMenu = function() { APP.menuOpen = !APP.menuOpen; render(); };
window.updateSearch = function(val) { 
    APP.search = val; 
    const input = document.getElementById('search-input');
    const cursorPos = input ? input.selectionStart : 0;
    render();
    setTimeout(function() {
        const newInput = document.getElementById('search-input');
        if (newInput) {
            newInput.focus();
            newInput.setSelectionRange(cursorPos, cursorPos);
        }
    }, 0);
};
window.selectPerson = function(id) { APP.selectedPerson = id; APP.view = 'person'; render(); };
window.setTab = function(tab) { APP.activeTab = tab; render(); };

window.startTimer = async function(personnelId, activityId, categoria) {
    const existing = APP.timeLogs.find(function(l) { return l.personnelId === personnelId && !l.endTime; });
    if (existing) {
        if (!confirm('Vuoi chiudere l\'attivit√† attiva?')) return;
        await window.stopTimer(existing.id);
    }
    await db.collection('timeLogs').add({
        personnelId: personnelId,
        activityId: activityId,
        categoria: categoria,
        startTime: firebase.firestore.Timestamp.now(),
        endTime: null,
        durationMinutes: null,
        note: '',
        source: 'TIMER'
    });
};

window.stopTimer = async function(logId) {
    const log = APP.timeLogs.find(function(l) { return l.id === logId; });
    const end = new Date();
    const start = new Date(log.startTime);
    const durationMinutes = Math.round((end - start) / 60000);
    await db.collection('timeLogs').doc(logId).update({
        endTime: firebase.firestore.Timestamp.now(),
        durationMinutes: durationMinutes
    });
};

window.submitManual = async function(e) {
    e.preventDefault();
    const form = e.target;
    const startDT = new Date(form.date.value + 'T' + form.startTime.value);
    const endDT = new Date(form.date.value + 'T' + form.endTime.value);
    if (endDT <= startDT) { alert('Orario fine deve essere dopo inizio'); return; }
    await db.collection('timeLogs').add({
        personnelId: form.personnelId.value,
        activityId: form.activityId.value,
        categoria: form.categoria.value,
        startTime: firebase.firestore.Timestamp.fromDate(startDT),
        endTime: firebase.firestore.Timestamp.fromDate(endDT),
        durationMinutes: Math.round((endDT - startDT) / 60000),
        note: form.note.value,
        source: 'MANUAL'
    });
    APP.view = 'person';
    render();
};

window.addPerson = async function(e) {
    e.preventDefault();
    const form = e.target;
    await db.collection('personnel').add({ nome: form.nome.value, cognome: form.cognome.value, attivo: true });
    form.reset();
    render();
};

window.togglePersonActive = async function(id, currentStatus) {
    await db.collection('personnel').doc(id).update({ attivo: !currentStatus });
    loadAllPersonnel();
};

window.deletePerson = async function(id) {
    if (!confirm('Sei sicuro di voler ELIMINARE definitivamente questa persona? Questa azione NON pu√≤ essere annullata!')) {
        return;
    }
    
    try {
        await db.collection('personnel').doc(id).delete();
        alert('Persona eliminata con successo');
        loadAllPersonnel();
    } catch (error) {
        alert('Errore durante l\'eliminazione: ' + error.message);
    }
};

window.editPerson = function(id, currentNome, currentCognome) {
    const newNome = prompt('Modifica Nome:', currentNome);
    if (newNome === null || newNome.trim() === '') return;
    
    const newCognome = prompt('Modifica Cognome:', currentCognome);
    if (newCognome === null || newCognome.trim() === '') return;
    
    db.collection('personnel').doc(id).update({
        nome: newNome.trim(),
        cognome: newCognome.trim()
    }).then(function() {
        alert('Persona modificata con successo');
        loadAllPersonnel();
    }).catch(function(error) {
        alert('Errore durante la modifica: ' + error.message);
    });
};

window.addActivity = async function(e) {
    e.preventDefault();
    const form = e.target;
    await db.collection('activities').add({ nome: form.nome.value, attiva: true });
    form.reset();
    render();
};

window.toggleActivityActive = async function(id, currentStatus) {
    await db.collection('activities').doc(id).update({ attiva: !currentStatus });
    loadAllActivities();
};

window.deleteLog = async function(logId) {
    if (!confirm('Sei sicuro di voler eliminare questa attivit√†? Questa azione non pu√≤ essere annullata.')) {
        return;
    }
    
    try {
        await db.collection('timeLogs').doc(logId).delete();
        alert('Attivit√† eliminata con successo');
    } catch (error) {
        alert('Errore durante l\'eliminazione: ' + error.message);
    }
};

function exportExcel() {
    const allLogs = APP.timeLogs.filter(function(l) { return l.endTime; });
    
    if (allLogs.length === 0) {
        alert('Nessun dato da esportare. Completa almeno un\'attivit√† prima di esportare.');
        return;
    }
    
    const wb = XLSX.utils.book_new();
    
    // FOGLIO 1: Log Dettagliato
    const logData = [];
    logData.push(['Data', 'Persona', 'Attivit√†', 'Categoria', 'Ora Inizio', 'Ora Fine', 'Durata (ore)', 'Note', 'Modalit√†']);
    
    for (let i = 0; i < allLogs.length; i++) {
        const log = allLogs[i];
        const person = APP.personnel.find(function(p) { return p.id === log.personnelId; });
        const activity = APP.activities.find(function(a) { return a.id === log.activityId; });
        
        const startDate = new Date(log.startTime);
        const endDate = new Date(log.endTime);
        
        logData.push([
            startDate.toLocaleDateString('it-IT'),
            person ? person.nome + ' ' + person.cognome : 'N/D',
            activity ? activity.nome : 'N/D',
            log.categoria === 'IN_ORARIO' ? 'Extra in Orario' : 'Extra Fuori Orario',
            startDate.toLocaleTimeString('it-IT', {hour: '2-digit', minute: '2-digit'}),
            endDate.toLocaleTimeString('it-IT', {hour: '2-digit', minute: '2-digit'}),
            (log.durationMinutes / 60).toFixed(2),
            log.note || '',
            log.source === 'TIMER' ? 'Timer' : 'Manuale'
        ]);
    }
    
    const ws1 = XLSX.utils.aoa_to_sheet(logData);
    ws1['!cols'] = [{wch:12},{wch:20},{wch:30},{wch:20},{wch:12},{wch:12},{wch:12},{wch:30},{wch:10}];
    XLSX.utils.book_append_sheet(wb, ws1, 'Log Dettagliato');
    
    // FOGLIO 2: Riepilogo per Persona
    const personStats = {};
    for (let i = 0; i < allLogs.length; i++) {
        const log = allLogs[i];
        const person = APP.personnel.find(function(p) { return p.id === log.personnelId; });
        if (!person) continue;
        
        const key = person.nome + ' ' + person.cognome;
        if (!personStats[key]) {
            personStats[key] = {
                inOrario: { minutes: 0, count: 0 },
                fuoriOrario: { minutes: 0, count: 0 },
                totale: { minutes: 0, count: 0 }
            };
        }
        
        if (log.categoria === 'IN_ORARIO') {
            personStats[key].inOrario.minutes += log.durationMinutes;
            personStats[key].inOrario.count++;
        } else {
            personStats[key].fuoriOrario.minutes += log.durationMinutes;
            personStats[key].fuoriOrario.count++;
        }
        
        personStats[key].totale.minutes += log.durationMinutes;
        personStats[key].totale.count++;
    }
    
    const personData = [];
    personData.push(['Persona', 'Ore Extra in Orario', 'N¬∞ Attivit√† in Orario', 'Ore Extra Fuori Orario', 'N¬∞ Attivit√† Fuori Orario', 'Totale Ore', 'Totale Attivit√†']);
    
    const personKeys = Object.keys(personStats).sort();
    for (let i = 0; i < personKeys.length; i++) {
        const name = personKeys[i];
        const data = personStats[name];
        personData.push([
            name,
            (data.inOrario.minutes / 60).toFixed(2),
            data.inOrario.count,
            (data.fuoriOrario.minutes / 60).toFixed(2),
            data.fuoriOrario.count,
            (data.totale.minutes / 60).toFixed(2),
            data.totale.count
        ]);
    }
    
    // Riga totali
    let totalInOrario = 0, totalFuoriOrario = 0, totalAll = 0;
    let countInOrario = 0, countFuoriOrario = 0, countAll = 0;
    for (let i = 0; i < personKeys.length; i++) {
        const data = personStats[personKeys[i]];
        totalInOrario += data.inOrario.minutes;
        totalFuoriOrario += data.fuoriOrario.minutes;
        totalAll += data.totale.minutes;
        countInOrario += data.inOrario.count;
        countFuoriOrario += data.fuoriOrario.count;
        countAll += data.totale.count;
    }
    
    personData.push([
        'TOTALE GENERALE',
        (totalInOrario / 60).toFixed(2),
        countInOrario,
        (totalFuoriOrario / 60).toFixed(2),
        countFuoriOrario,
        (totalAll / 60).toFixed(2),
        countAll
    ]);
    
    const ws2 = XLSX.utils.aoa_to_sheet(personData);
    ws2['!cols'] = [{wch:20},{wch:20},{wch:20},{wch:22},{wch:24},{wch:15},{wch:18}];
    XLSX.utils.book_append_sheet(wb, ws2, 'Riepilogo Persone');
    
    // FOGLIO 3: Riepilogo per Attivit√†
    const activityStats = {};
    for (let i = 0; i < allLogs.length; i++) {
        const log = allLogs[i];
        const activity = APP.activities.find(function(a) { return a.id === log.activityId; });
        if (!activity) continue;
        
        const key = activity.nome;
        if (!activityStats[key]) {
            activityStats[key] = {
                inOrario: { minutes: 0, count: 0 },
                fuoriOrario: { minutes: 0, count: 0 },
                totale: { minutes: 0, count: 0 }
            };
        }
        
        if (log.categoria === 'IN_ORARIO') {
            activityStats[key].inOrario.minutes += log.durationMinutes;
            activityStats[key].inOrario.count++;
        } else {
            activityStats[key].fuoriOrario.minutes += log.durationMinutes;
            activityStats[key].fuoriOrario.count++;
        }
        
        activityStats[key].totale.minutes += log.durationMinutes;
        activityStats[key].totale.count++;
    }
    
    const activityData = [];
    activityData.push(['Attivit√†', 'Ore in Orario', 'N¬∞ in Orario', 'Ore Fuori Orario', 'N¬∞ Fuori Orario', 'Totale Ore', 'Totale N¬∞']);
    
    const activityKeys = Object.keys(activityStats).sort();
    for (let i = 0; i < activityKeys.length; i++) {
        const name = activityKeys[i];
        const data = activityStats[name];
        activityData.push([
            name,
            (data.inOrario.minutes / 60).toFixed(2),
            data.inOrario.count,
            (data.fuoriOrario.minutes / 60).toFixed(2),
            data.fuoriOrario.count,
            (data.totale.minutes / 60).toFixed(2),
            data.totale.count
        ]);
    }
    
    // Riga totali attivit√†
    let actTotalIn = 0, actTotalOut = 0, actTotalAll = 0;
    let actCountIn = 0, actCountOut = 0, actCountAll = 0;
    for (let i = 0; i < activityKeys.length; i++) {
        const data = activityStats[activityKeys[i]];
        actTotalIn += data.inOrario.minutes;
        actTotalOut += data.fuoriOrario.minutes;
        actTotalAll += data.totale.minutes;
        actCountIn += data.inOrario.count;
        actCountOut += data.fuoriOrario.count;
        actCountAll += data.totale.count;
    }
    
    activityData.push([
        'TOTALE GENERALE',
        (actTotalIn / 60).toFixed(2),
        actCountIn,
        (actTotalOut / 60).toFixed(2),
        actCountOut,
        (actTotalAll / 60).toFixed(2),
        actCountAll
    ]);
    
    const ws3 = XLSX.utils.aoa_to_sheet(activityData);
    ws3['!cols'] = [{wch:30},{wch:15},{wch:15},{wch:18},{wch:18},{wch:15},{wch:12}];
    XLSX.utils.book_append_sheet(wb, ws3, 'Riepilogo Attivit√†');
    
    // Genera e scarica il file
    const today = new Date().toISOString().split('T')[0];
    XLSX.writeFile(wb, 'ONCOTRACKING_Report_' + today + '.xlsx');
    
    alert('Report Excel scaricato con successo!');
}

seedInitialData().then(function() { initFirebase(); });
</script>
</body>
</html>